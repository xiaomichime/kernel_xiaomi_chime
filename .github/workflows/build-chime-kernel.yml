name: Build & Release chime Kernel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-24.04

    env:
      KERNEL_REPO: xiaomichime/kernel_xiaomi_chime
      KERNEL_BRANCH: main
      DEFCONFIG: chime_defconfig
      PROTON_CLANG_REPO: https://github.com/xiaomichime/proton-clang
      PROTON_CLANG_BRANCH: master
      ANYKERNEL_REPO: osm0sis/AnyKernel3
      ANYKERNEL_BRANCH: master

    steps:

    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: ${{ env.KERNEL_REPO }}
        ref: ${{ env.KERNEL_BRANCH }}
        fetch-depth: 0

    - name: Checkout AnyKernel3
      uses: actions/checkout@v4
      with:
        repository: ${{ env.ANYKERNEL_REPO }}
        ref: ${{ env.ANYKERNEL_BRANCH }}
        path: anykernel3
        fetch-depth: 1

    - name: Setup Build Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc build-essential curl git unzip zip

    - name: Cache Clang Toolchain
      uses: actions/cache@v4
      with:
        path: proton-clang
        key: clang-proton-${{ env.PROTON_CLANG_BRANCH }}-${{ runner.os }}
        restore-keys: |
          clang-proton-${{ env.PROTON_CLANG_BRANCH }}-

    - name: Install Proton-Clang
      run: |
        if [ ! -d "proton-clang" ]; then
          git clone --depth=1 --branch ${{ env.PROTON_CLANG_BRANCH }} ${{ env.PROTON_CLANG_REPO }} proton-clang
        fi
        echo "Added clang to PATH"
        echo "${{ github.workspace }}/proton-clang/bin" >> $GITHUB_PATH

    - name: Apply KernelSU
      run: |
        set -o pipefail
        curl -fsSL https://raw.githubusercontent.com/resukisu/Resukisu/main/kernel/setup.sh | bash -s main || true

    - name: Configure Kernel
      run: |
        make O=out ARCH=arm64 ${{ env.DEFCONFIG }}

    - name: Build Kernel
      run: |
        make -j$(nproc) O=out ARCH=arm64 \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          STRIP=llvm-strip \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          READELF=llvm-readelf

    - name: Show Build Output
      if: failure()
      run: |
        echo "===== Build failed, dumping build output ====="
        ls -R out || true
        find out -type f -maxdepth 2 -print

    - name: Package ZIP
      run: |
        mkdir -p anykernel3/out
        cp out/arch/arm64/boot/Image.gz-dtb anykernel3/
        cd anykernel3
        zip -r9 chime-kernel-flashable.zip .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: chime-kernel-flashable
        path: anykernel3/chime-kernel-flashable.zip

    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: "v${{ github.run_number }}"
        name: "chime-kernel-v${{ github.run_number }}"
        artifacts: anykernel3/chime-kernel-flashable.zip
